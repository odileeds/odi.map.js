/**
  ODI Leeds Tiny Slippy Map
  Plugin for overlays (e.g. GeoJSON)
  Version 0.1.4
**/
!function(t){function e(t){return document.createElementNS(n,t)}var s=t.ODI||{};function i(t,e){for(var s in e)null!=t[s]&&(t[e[s]]=t[s],delete t[s]);return t}if(s.map){var n="http://www.w3.org/2000/svg";s.map.prototype.register("overlay",{version:"0.1.4",exec:function(t){function n(t,e){return this.bindPopup=function(i){return this._popuptext=i,t.marker?this._el=t.marker._el.querySelector("path"):t._svg&&(this._el=t._svg),s._addEvent("click",this._el,{popup:i,el:this._el,this:this},function(t){o.bindPopup(t.data.popup).addTo(e.panes.p.popup.el).setTarget(this._el).openPopup().setPosition(t.target)}),this},this}var o=new function(){return this.open=!1,this.bindPopup=function(t){return this.txt=t,this},this.openPopup=function(){if(!this.pane)return this;var t=this.pane.querySelector(".odi-map-popup");return t&&t.parentNode.removeChild(t),(t=document.createElement("div")).classList.add("odi-map-popup"),this.pane.appendChild(t),t.innerHTML='<div class="odi-map-popup-inner">'+this.txt+"</div>",this.p=t,this.open=!0,this},this.addTo=function(t){return this.pane=t,this},this.setTarget=function(t){return t&&(this._target=t),this},this.setPosition=function(t){if(this.p&&this.open){var e=this._target.getBoundingClientRect(),i=this.pane.getBoundingClientRect();s._setAttr(this.p,{style:"top:"+(e.top-i.top).toFixed(1)+"px;left:"+(e.left-i.left+e.width/2).toFixed(1)+"px;"})}return this},this};s.map.geoJSON=function(r,a){return a||(a={}),a.pane||(a.pane="overlay"),new class extends t.Layer{constructor(t,e,s){super(e,s),this._json=t||{},this._attr=e||{}}addTo(t){var i,n;if(this._map=t,i=this._attr.pane,!t.panes.p[i])return t.log("ERROR","No pane %c"+i+"%c exists.","font-style:italic;","");this._el=t.panes.p[i].el.querySelector(".odi-map-layer"),this._el?this._svg=this._el.querySelector("svg"):((n=document.createElement("div")).classList.add("odi-map-layer"),t.panes.p[i].el.appendChild(n),this._el=n,this._svg=e("svg"),s._setAttr(this._svg,{overflow:"visible",preserveAspectRatio:"xMinYMin meet","vector-effect":"non-scaling-stroke"}),this._el.appendChild(this._svg)),t.panes.p[i].el.appendChild(this._el),t.panes.p[i].layers.push(this),this.update(this._map.getBounds(),this._map.getZoom())}update(t,r){var a,p,h,l,_,u,d,f,c,g,v,y,m,x,L,j;for(a=t.getCenter().toPx(r),l=t.nw.toPx(r),_=t.se.toPx(r),x={opacity:1,fillOpacity:.2,weight:3,color:"#3388ff",stroke:!0},s._setAttr(this._svg,{viewBox:(l.x-a.x).toFixed(3)+" "+(l.y-a.y).toFixed(3)+" "+(_.x-l.x).toFixed(3)+" "+(_.y-l.y).toFixed(3)}),p=0;p<this._json.features.length;p++){if(y={},m={},"function"==typeof this._attr.style?m=this._attr.style.call(this,this._json.features[p])||{}:"object"==typeof this._attr.style&&(m=this._attr.style),y=Object.assign({},x,m),d=(j=this._json.features[p].geometry).coordinates,"Point"==j.type)this._json.features[p].marker||(L={svg:'<path d="M 0,0 L -10.84,-22.86 A 12 12 1 1 1 10.84,-22.86 L 0,0 z" fill="%COLOUR%" fill-opacity="1"></path><ellipse cx="0" cy="-27.5" rx="4" ry="4" fill="white"></ellipse>'.replace(/%COLOUR%/,y.fillColor||x.color)},this._json.features[p].marker=s.map.marker(this._map.LatLon(d[1],d[0]),L),this._json.features[p].marker.addTo(this._map));else if("Polygon"==j.type){for(this._json.features[p]._svg||(u=e("path"),this._svg.appendChild(u),this._json.features[p]._svg=u),v="",f=0;f<d.length;f++)for(c=0;c<d[f].length;c++)h=this._map.LatLon(d[f][c][1],d[f][c][0]).toPx(r),v+=(0==c?"M":"L")+" "+(h.x-a.x)+" "+(h.y-a.y);y.d=v,y.fill=!0}else if("LineString"==j.type){for(this._json.features[p]._svg||(u=e("path"),s._setAttr(u,{r:5,stroke:"black","stroke-width":1,fill:"none"}),this._svg.appendChild(u),this._json.features[p]._svg=u),v="",f=0;f<d.length;f++)h=this._map.LatLon(d[f][1],d[f][0]).toPx(r),v+=(0==f?"M":"L")+(h.x-a.x)+" "+(h.y-a.y);y.d=v,y.fill=!1}else if("MultiLineString"==j.type){for(this._json.features[p]._svg||(u=e("path"),s._setAttr(u,{r:5,stroke:"black","stroke-width":1,fill:"none"}),this._svg.appendChild(u),this._json.features[p]._svg=u),v="",f=0;f<d.length;f++)for(c=0;c<d[f].length;c++)h=this._map.LatLon(d[f][c][1],d[f][c][0]).toPx(r),v+=(0==c?"M":"L")+(h.x-a.x)+" "+(h.y-a.y);y.d=v,y.fill=!1}else if("MultiPolygon"==j.type){for(this._json.features[p]._svg||(u=e("path"),this._svg.appendChild(u),this._json.features[p]._svg=u),v="",f=0;f<d.length;f++)for(c=0;c<d[f].length;c++)if(2!=d[f][c].length)for(g=0;g<d[f][c].length;g++)h=this._map.LatLon(d[f][c][g][1],d[f][c][g][0]).toPx(r),v+=(0==g?"M":"L")+" "+(h.x-a.x)+" "+(h.y-a.y);y.d=v,y.fill=!0}this._json.features[p]._svg&&(y.fill&&!y.fillColor&&(y.fillColor=y.color+""),y=i(y,{fillColor:"fill",color:"stroke",opacity:"stroke-opacity",fillOpacity:"fill-opacity",weight:"stroke-width"}),this._json.features[p]._svg.innerHTML=y.title?"<title>"+y.title+"</title>":"",s._setAttr(this._json.features[p]._svg,y)),this._json.features[p]._added||"function"!=typeof this._attr.onEachFeature||(this._json.features[p]._thing=new n(this._json.features[p],this._map),this._attr.onEachFeature.call(this,this._json.features[p],this._json.features[p]._thing),this._json.features[p]._added=!0)}o.setPosition()}}(r,a)},s.map.marker=function(i,n){return n||(n={}),n.pane||(n.pane="marker"),new class extends t.Layer{constructor(t,i,n){super(i,n),this._ll=t||s.map.LatLon(),this._el=e("svg"),this._el.innerHTML=i.svg,s._setAttr(this._el,{overflow:"visible",width:"1",height:"1"})}addTo(t){this._map=t;var e=this._attr.pane;return t.panes.p[e]?(t.panes.p[e].el.appendChild(this._el),t.panes.p[e].layers.push(this),this.setLatLon(this._ll),this):t.log("ERROR","No pane %c"+e+"%c exists.","font-style:italic;","")}update(t,e){return this.setLatLon(this._ll,t.getCenter().toPx(e))}setLatLon(t,e){var i,n;return i=this._map.getZoom(),e||(e=this._map.getCenter().toPx(i)),n=t.toPx(i),s._setAttr(this._el,{class:"odi-map-marker",style:"transform:translate3d("+(n.x-e.x)+"px,"+(n.y-e.y)+"px,0)"}),this}bindPopup(t){return this._popup=t,s._addEvent("click",this._el,{popup:t,this:this},function(t){o.bindPopup(this._popup).addTo(this._map.panes.p.popup.el).setTarget(this._el.childNodes[0]).openPopup().setPosition(t.target)}),this}openPopup(){var t=document.createEvent("HTMLEvents");return t.initEvent("click",!0,!1),this._el.dispatchEvent(t),this}}(i,n)}}})}t.ODI=s}(window||this);