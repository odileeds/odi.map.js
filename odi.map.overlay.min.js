/**
  ODI Leeds Tiny Slippy Map
  Plugin for overlays (e.g. GeoJSON)
  Version 0.1.2
**/
!function(t){function e(t){return document.createElementNS(o,t)}var s=t.ODI||{};function i(t,e){for(var s in e)null!=t[s]&&(t[e[s]]=t[s],delete t[s]);return t}if(s.map){var o="http://www.w3.org/2000/svg";s.map.prototype.register("overlay",{version:"0.1.2",exec:function(t){function n(t,e){return this.bindPopup=function(i){return this._popuptext=i,t.marker?this._el=t.marker._el.querySelector("path"):t.svg&&(this._el=t.svg),s._addEvent("click",this._el,{popup:i,el:this._el,this:this},function(t){var s=e.panes.p.popup.el.querySelector(".odi-map-popup");s&&s.parentNode.removeChild(s),this._popup=document.createElement("div"),this._popup.classList.add("odi-map-popup"),e.panes.p.popup.el.appendChild(this._popup),this._popup.innerHTML='<div class="odi-map-popup-inner">'+t.data.popup+"</div>",this.setPosition()}),this},this.setPosition=function(){if(this._popup){var t=this._el.getBoundingClientRect(),i=e.panes.p.popup.el.getBoundingClientRect();s._setAttr(this._popup,{style:"top:"+(t.top-i.top)+"px;left:"+(t.left-i.left+t.width/2)+"px;"})}},this}s.map.geoJSON=function(a,r){return r||(r={}),r.pane||(r.pane="overlay"),new class extends t.Layer{constructor(t,i,n){super(i,n),this._json=t||{},this._svg=e("svg"),this._init=!1,s._setAttr(this._svg,{xmlns:o,version:"1.1",overflow:"visible",preserveAspectRatio:"xMinYMin meet","vector-effect":"non-scaling-stroke"}),this._el.appendChild(this._svg)}update(t,o){var a,r,p,l,h,_,f,u,d,g,c,v,y,m,x;for(a=t.getCenter().toPx(o),l=t.nw.toPx(o),h=t.se.toPx(o),y={opacity:1,fillOpacity:.2,weight:3,color:"#3388ff",stroke:!0},s._setAttr(this._svg,{viewBox:(l.x-a.x).toFixed(3)+" "+(l.y-a.y).toFixed(3)+" "+(h.x-l.x).toFixed(3)+" "+(h.y-l.y).toFixed(3)}),r=0;r<this._json.features.length;r++){if(v={},"function"==typeof this._attr.style&&(v=Object.assign({},y,this._attr.style.call(this,this._json.features[r])||{})),f=(x=this._json.features[r].geometry).coordinates,"Point"==x.type)this._json.features[r].marker?this._json.features[r].marker.setLatLon(this._map.LatLon(f[1],f[0])):(m={svg:'<path d="M 0,0 L -10.84,-22.86 A 12 12 1 1 1 10.84,-22.86 L 0,0 z" fill="%COLOUR%" fill-opacity="1"></path><ellipse cx="0" cy="-27.5" rx="4" ry="4" fill="white"></ellipse>'.replace(/%COLOUR%/,v.fillColor||y.color)},this._json.features[r].marker=s.map.marker(this._map.LatLon(f[1],f[0]),m).addTo(this._map));else if("Polygon"==x.type){for(this._json.features[r].svg||(_=e("path"),this._svg.appendChild(_),this._json.features[r].svg=_),c="",u=0;u<f.length;u++)for(d=0;d<f[u].length;d++)p=this._map.LatLon(f[u][d][1],f[u][d][0]).toPx(o),c+=(0==d?"M":"L")+" "+(p.x-a.x)+" "+(p.y-a.y);v.d=c,v.fill=!0}else if("LineString"==x.type){for(this._json.features[r].svg||(_=e("path"),s._setAttr(_,{r:5,stroke:"black","stroke-width":1,fill:"none"}),this._svg.appendChild(_),this._json.features[r].svg=_),c="",u=0;u<f.length;u++)p=this._map.LatLon(f[u][1],f[u][0]).toPx(o),c+=(0==u?"M":"L")+(p.x-a.x)+" "+(p.y-a.y);v.d=c,v.fill=!1}else if("MultiLineString"==x.type){for(this._json.features[r].svg||(_=e("path"),s._setAttr(_,{r:5,stroke:"black","stroke-width":1,fill:"none"}),this._svg.appendChild(_),this._json.features[r].svg=_),c="",u=0;u<f.length;u++)for(d=0;d<f[u].length;d++)p=this._map.LatLon(f[u][d][1],f[u][d][0]).toPx(o),c+=(0==d?"M":"L")+(p.x-a.x)+" "+(p.y-a.y);v.d=c,v.fill=!1}else if("MultiPolygon"==x.type){for(this._json.features[r].svg||(_=e("path"),this._svg.appendChild(_),this._json.features[r].svg=_),c="",u=0;u<f.length;u++)for(d=0;d<f[u].length;d++)if(2!=f[u][d].length)for(g=0;g<f[u][d].length;g++)p=this._map.LatLon(f[u][d][g][1],f[u][d][g][0]).toPx(o),c+=(0==g?"M":"L")+" "+(p.x-a.x)+" "+(p.y-a.y);v.d=c,v.fill=!0}this._json.features[r].svg&&(v.fill&&!v.fillColor&&(v.fillColor=v.color+""),v=i(v,{fillColor:"fill",color:"stroke",opacity:"stroke-opacity",fillOpacity:"fill-opacity",weight:"stroke-width"}),this._json.features[r].svg.innerHTML=v.title?"<title>"+v.title+"</title>":"",s._setAttr(this._json.features[r].svg,v)),this._init||"function"!=typeof this._attr.onEachFeature||(this._json.features[r]._thing=new n(this._json.features[r],this._map),this._attr.onEachFeature.call(this,this._json.features[r],this._json.features[r]._thing)),this._json.features[r]._thing.setPosition()}this._init=!0}addTo(t){var e,i;this._map=t;var o=this._attr.pane;if(!t.panes.p[o])return t.log("ERROR","No pane %c"+o+"%c exists.","font-style:italic;","");t.panes.p[o].el.appendChild(this._el),t.panes.p[o].layers.push(this),this.update(this._map.getBounds(),this._map.getZoom()),e=this._el.offsetWidth,i=this._el.offsetHeight,s._setAttr(this._svg,{viewBox:"0 0 "+e+" "+i,width:e,height:i})}}(a,r)},s.map.marker=function(i,n){return n||(n={}),n.pane||(n.pane="marker"),new class extends t.Layer{constructor(t,i,n){super(i,n),this._ll=t||s.map.LatLon(),this._el=e("svg"),this._el.innerHTML=i.svg,s._setAttr(this._el,{xmlns:o,version:"1.1",overflow:"visible",width:"0",height:"0"})}addTo(t){this._map=t;var e=this._attr.pane;return t.panes.p[e]?(t.panes.p[e].el.appendChild(this._el),t.panes.p[e].layers.push(this),this.setLatLon(this._ll),this):t.log("ERROR","No pane %c"+e+"%c exists.","font-style:italic;","")}setLatLon(t,e){var i,o;i=this._map.getZoom(),e||(e=this._map.getCenter().toPx(i)),o=t.toPx(i),s._setAttr(this._el,{class:"odi-map-marker",style:"transform:translate3d("+(o.x-e.x)+"px,"+(o.y-e.y)+"px,0)"})}}(i,n)}}})}t.ODI=s}(window||this);