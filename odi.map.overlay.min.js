/**
  ODI Leeds Tiny Slippy Map
  Plugin for overlays (e.g. GeoJSON)
  Version 0.1.4
**/
!function(t){function e(t){return document.createElementNS(o,t)}var s=t.ODI||{};function i(t,e){for(var s in e)null!=t[s]&&(t[e[s]]=t[s],delete t[s]);return t}if(s.map){var o="http://www.w3.org/2000/svg";s.map.prototype.register("overlay",{version:"0.1.4",exec:function(t){function o(t,e){return this.bindPopup=function(i){return this._popuptext=i,t.marker?this._el=t.marker._el.querySelector("path"):t._svg&&(this._el=t._svg),s._addEvent("click",this._el,{popup:i,el:this._el,this:this},function(t){var s=e.panes.p.popup.el.querySelector(".odi-map-popup");s&&s.parentNode.removeChild(s),this._popup=document.createElement("div"),this._popup.classList.add("odi-map-popup"),e.panes.p.popup.el.appendChild(this._popup),this._popup.innerHTML='<div class="odi-map-popup-inner">'+t.data.popup+"</div>",this.setPosition()}),this},this.setPosition=function(){if(this._popup){var t=this._el.getBoundingClientRect(),i=e.panes.p.popup.el.getBoundingClientRect();s._setAttr(this._popup,{style:"top:"+(t.top-i.top).toFixed(1)+"px;left:"+(t.left-i.left+t.width/2).toFixed(1)+"px;"})}},this}s.map.geoJSON=function(a,n){return n||(n={}),n.pane||(n.pane="overlay"),new class extends t.Layer{constructor(t,e,s){super(e,s),this._json=t||{},this._attr=e||{}}addTo(t){var i,o;if(this._map=t,i=this._attr.pane,!t.panes.p[i])return t.log("ERROR","No pane %c"+i+"%c exists.","font-style:italic;","");this._el=t.panes.p[i].el.querySelector(".odi-map-layer"),this._el?this._svg=this._el.querySelector("svg"):((o=document.createElement("div")).classList.add("odi-map-layer"),t.panes.p[i].el.appendChild(o),this._el=o,this._svg=e("svg"),s._setAttr(this._svg,{overflow:"visible",preserveAspectRatio:"xMinYMin meet","vector-effect":"non-scaling-stroke"}),this._el.appendChild(this._svg)),t.panes.p[i].el.appendChild(this._el),t.panes.p[i].layers.push(this),this.update(this._map.getBounds(),this._map.getZoom())}update(t,a){var n,r,p,l,h,_,f,u,d,c,g,y,v,m,x,L;for(n=t.getCenter().toPx(a),l=t.nw.toPx(a),h=t.se.toPx(a),m={opacity:1,fillOpacity:.2,weight:3,color:"#3388ff",stroke:!0},s._setAttr(this._svg,{viewBox:(l.x-n.x).toFixed(3)+" "+(l.y-n.y).toFixed(3)+" "+(h.x-l.x).toFixed(3)+" "+(h.y-l.y).toFixed(3)}),r=0;r<this._json.features.length;r++){if(y={},v={},"function"==typeof this._attr.style?v=this._attr.style.call(this,this._json.features[r])||{}:"object"==typeof this._attr.style&&(v=this._attr.style),y=Object.assign({},m,v),f=(L=this._json.features[r].geometry).coordinates,"Point"==L.type)this._json.features[r].marker?this._json.features[r].marker.setLatLon(this._map.LatLon(f[1],f[0]),n):(x={svg:'<path d="M 0,0 L -10.84,-22.86 A 12 12 1 1 1 10.84,-22.86 L 0,0 z" fill="%COLOUR%" fill-opacity="1"></path><ellipse cx="0" cy="-27.5" rx="4" ry="4" fill="white"></ellipse>'.replace(/%COLOUR%/,y.fillColor||m.color)},this._json.features[r].marker=s.map.marker(this._map.LatLon(f[1],f[0]),x),this._json.features[r].marker.addTo(this._map));else if("Polygon"==L.type){for(this._json.features[r]._svg||(_=e("path"),this._svg.appendChild(_),this._json.features[r]._svg=_),g="",u=0;u<f.length;u++)for(d=0;d<f[u].length;d++)p=this._map.LatLon(f[u][d][1],f[u][d][0]).toPx(a),g+=(0==d?"M":"L")+" "+(p.x-n.x)+" "+(p.y-n.y);y.d=g,y.fill=!0}else if("LineString"==L.type){for(this._json.features[r]._svg||(_=e("path"),s._setAttr(_,{r:5,stroke:"black","stroke-width":1,fill:"none"}),this._svg.appendChild(_),this._json.features[r]._svg=_),g="",u=0;u<f.length;u++)p=this._map.LatLon(f[u][1],f[u][0]).toPx(a),g+=(0==u?"M":"L")+(p.x-n.x)+" "+(p.y-n.y);y.d=g,y.fill=!1}else if("MultiLineString"==L.type){for(this._json.features[r]._svg||(_=e("path"),s._setAttr(_,{r:5,stroke:"black","stroke-width":1,fill:"none"}),this._svg.appendChild(_),this._json.features[r]._svg=_),g="",u=0;u<f.length;u++)for(d=0;d<f[u].length;d++)p=this._map.LatLon(f[u][d][1],f[u][d][0]).toPx(a),g+=(0==d?"M":"L")+(p.x-n.x)+" "+(p.y-n.y);y.d=g,y.fill=!1}else if("MultiPolygon"==L.type){for(this._json.features[r]._svg||(_=e("path"),this._svg.appendChild(_),this._json.features[r]._svg=_),g="",u=0;u<f.length;u++)for(d=0;d<f[u].length;d++)if(2!=f[u][d].length)for(c=0;c<f[u][d].length;c++)p=this._map.LatLon(f[u][d][c][1],f[u][d][c][0]).toPx(a),g+=(0==c?"M":"L")+" "+(p.x-n.x)+" "+(p.y-n.y);y.d=g,y.fill=!0}this._json.features[r]._svg&&(y.fill&&!y.fillColor&&(y.fillColor=y.color+""),y=i(y,{fillColor:"fill",color:"stroke",opacity:"stroke-opacity",fillOpacity:"fill-opacity",weight:"stroke-width"}),this._json.features[r]._svg.innerHTML=y.title?"<title>"+y.title+"</title>":"",s._setAttr(this._json.features[r]._svg,y)),this._json.features[r]._added||"function"!=typeof this._attr.onEachFeature||(this._json.features[r]._thing=new o(this._json.features[r],this._map),this._attr.onEachFeature.call(this,this._json.features[r],this._json.features[r]._thing),this._json.features[r]._added=!0),this._json.features[r]._thing&&this._json.features[r]._thing.setPosition()}}}(a,n)},s.map.marker=function(i,o){return o||(o={}),o.pane||(o.pane="marker"),new class extends t.Layer{constructor(t,i,o){super(i,o),this._ll=t||s.map.LatLon(),this._el=e("svg"),this._el.innerHTML=i.svg,s._setAttr(this._el,{overflow:"visible",width:"1",height:"1"})}addTo(t){this._map=t;var e=this._attr.pane;return t.panes.p[e]?(t.panes.p[e].el.appendChild(this._el),t.panes.p[e].layers.push(this),this.setLatLon(this._ll),this):t.log("ERROR","No pane %c"+e+"%c exists.","font-style:italic;","")}setLatLon(t,e){var i,o;i=this._map.getZoom(),e||(e=this._map.getCenter().toPx(i)),o=t.toPx(i),s._setAttr(this._el,{class:"odi-map-marker",style:"transform:translate3d("+(o.x-e.x)+"px,"+(o.y-e.y)+"px,0)"})}}(i,o)}}})}t.ODI=s}(window||this);